{% extends "base.html" %}
{% block title_suffix %} — CMDB Full{% endblock %}
{% block page_title %}CMDB Full{% endblock %}
{% block page_subtitle %}Visão Integrada de Bancos de Dados — GetNet / PagoNxt{% endblock %}

{% block content %}
<div class="content">
    <div class="cmdb-header-actions">
            <div class="filter-group">
                <select id="client" onchange="applyFilters()">
                    <option value="">Todos os Clientes</option>
                </select>
                <select id="db_type" onchange="applyFilters()">
                    <option value="">Todas Tecnologias</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="triggerCMDBImport()">
                <svg viewBox="0 0 24 24" class="btn-icon" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
                </svg>
                Importar CMDB Full
            </button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
                </svg>
            </div>
            <div class="kpi-content">
                <h3 id="statTotal">-</h3>
                <p>Total Servidores DB</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 11-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
            </div>
            <div class="kpi-content">
                <h3 id="statActive">-</h3>
                <p>Ativos / Running</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87" />
                    <path d="M16 3.13a4 4 0 010 7.75" />
                </svg>
            </div>
            <div class="kpi-content">
                <h3 id="statClients">-</h3>
                <p>Clientes Mapeados</p>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                    <line x1="8" y1="21" x2="16" y2="21" />
                    <line x1="12" y1="17" x2="12" y2="21" />
                </svg>
            </div>
            <div class="kpi-content">
                <h3 id="statEnvs">-</h3>
                <p>Ambientes</p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
        <div class="chart-card">
            <div class="card-header">
                <h3>Distribuição por Tecnologia</h3>
            </div>
            <div class="chart-container">
                <canvas id="dbTypeChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="card-header">
                <h3>Servidores por Ambiente</h3>
            </div>
            <div class="chart-container">
                <canvas id="envChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container fade-in">
        <div class="toolbar">
            <input type="text" id="searchInput" placeholder="Buscar hostname, sistema, IP..." onkeyup="handleSearch()">
            <div class="pagination-controls">
                <button onclick="prevPage()" id="prevBtn" disabled>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
                <span id="pageInfo">Página 1 de 1</span>
                <button onclick="nextPage()" id="nextBtn" disabled>
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Hostname</th>
                        <th>Tipo BD</th>
                        <th>Versão</th>
                        <th>Ambiente</th>
                        <th>Status</th>
                        <th>IP Serviço</th>
                        <th>Sistema / Produto</th>
                        <th>Observação</th>
                    </tr>
                </thead>
                <tbody id="cmdbTableBody">
                    <!-- Rows injected by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentPage = 1;
    let totalPages = 1;
    let searchTimeout = null;
    let dbTypeChart = null;
    let envChart = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadFilters();
        loadStats();
        loadData();
    });

    async function applyFilters() {
        currentPage = 1;
        loadStats(); // Update charts based on filters
        loadData();
    }

    function handleSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadData();
        }, 300);
    }

    async function loadFilters() {
        const res = await fetch('/api/cmdb-full/filters');
        const data = await res.json();

        populateSelect('client', data.clients);
        populateSelect('db_type', data.db_types);
    }

    function populateSelect(id, options) {
        const select = document.getElementById(id);
        const current = select.value;
        // Keep first option (All)
        select.innerHTML = select.options[0].outerHTML;

        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt;
            el.textContent = opt;
            select.appendChild(el);
        });
        select.value = current;
    }

    async function loadStats() {
        const client = document.getElementById('client').value;
        const res = await fetch(`/api/cmdb-full/stats?client=${encodeURIComponent(client)}`);
        const stats = await res.json();

        // Update KPIs
        animateValue("statTotal", stats.total);
        animateValue("statActive", stats.active);
        animateValue("statClients", stats.by_client.length);
        animateValue("statEnvs", stats.by_environment.length);

        renderCharts(stats);
    }

    function renderCharts(stats) {
        const ctxDb = document.getElementById('dbTypeChart').getContext('2d');
        const ctxEnv = document.getElementById('envChart').getContext('2d');

        if (dbTypeChart) dbTypeChart.destroy();
        if (envChart) envChart.destroy();

        // Colors
        const colors = [
            '#0088ee', '#00bbff', '#00eebb', '#ffaa00', '#ff4444',
            '#aa00ff', '#ff00aa', '#888888', '#444444', '#222222'
        ];

        // DB Type Chart (Bar - Horizontal)
        dbTypeChart = new Chart(ctxDb, {
            type: 'bar',
            data: {
                labels: stats.by_db_type.map(x => x.db_type),
                datasets: [{
                    label: 'Servidores',
                    data: stats.by_db_type.map(x => x.cnt),
                    backgroundColor: colors,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { grid: { display: false } }
                }
            }
        });

        // Environment Chart (Doughnut)
        envChart = new Chart(ctxEnv, {
            type: 'doughnut',
            data: {
                labels: stats.by_environment.map(x => x.environment),
                datasets: [{
                    data: stats.by_environment.map(x => x.cnt),
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#e0e0e0' } }
                },
                cutout: '60%'
            }
        });
    }

    async function loadData() {
        const client = document.getElementById('client').value;
        const db_type = document.getElementById('db_type').value;
        const search = document.getElementById('searchInput').value;

        const params = new URLSearchParams({
            page: currentPage,
            per_page: 50,
            search: search
        });
        if (client) params.append('client', client);
        if (db_type) params.append('db_type', db_type);

        const res = await fetch(`/api/cmdb-full?${params}`);
        const data = await res.json();

        updateTable(data.data);
        updatePagination(data);
    }

    function updateTable(rows) {
        const tbody = document.getElementById('cmdbTableBody');
        tbody.innerHTML = '';

        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum registro encontrado.</td></tr>';
            return;
        }

        rows.forEach(row => {
            const tr = document.createElement('tr');

            // Status Badge Color
            let statusClass = 'status-default';
            if (['Ativo', 'Running'].includes(row.status)) statusClass = 'status-ok';
            else if (row.status && row.status.includes('Descontinuado')) statusClass = 'status-critical';
            else if (row.status && row.status.includes('Construção')) statusClass = 'status-warning';

            // DB Logo Logic
            let logoHtml = '';
            // Safe lower case check
            const dbLower = (row.db_type || '').toLowerCase();

            if (dbLower.includes('oracle')) logoHtml = '<img src="/static/img/logos/oracle.png" class="db-logo" alt="Oracle">';
            else if (dbLower.includes('sql server') || dbLower.includes('sqlserver')) logoHtml = '<img src="/static/img/logos/sqlserver.jpg" class="db-logo" alt="SQL Server">';
            else if (dbLower.includes('mongo')) logoHtml = '<img src="/static/img/logos/mongodb.webp" class="db-logo" alt="MongoDB">';
            else if (dbLower.includes('mysql')) logoHtml = '<img src="/static/img/logos/mysql.png" class="db-logo" alt="MySQL">';
            else if (dbLower.includes('postgres')) logoHtml = '<img src="/static/img/logos/postgres.png" class="db-logo" alt="PostgreSQL">';
            else logoHtml = '<div class="db-logo-placeholder">' + (row.db_type ? row.db_type.substring(0, 2).toUpperCase() : 'DB') + '</div>';

            tr.innerHTML = `
                <td><span class="badge ${row.client === 'GetNet' ? 'badge-blue' : 'badge-red'}">${row.client}</span></td>
                <td class="font-mono font-medium">${row.hostname || '-'}</td>
                <td>
                    <div class="flex items-center gap-2">
                        ${logoHtml}
                        <span class="font-bold">${row.db_type}</span>
                    </div>
                </td>
                <td>${row.db_version || '<span class="text-muted">-</span>'}</td>
                <td>${row.environment || '-'}</td>
                <td><span class="status-badge ${statusClass}">${row.status || 'N/A'}</span></td>
                <td class="font-mono text-sm">${row.ip_service || row.ip_backup || '-'}</td>
                <td class="truncate" title="${row.system_product || ''}">${row.system_product || '-'}</td>
                <!-- Adicionando coluna Observação solicitada pelo usuário -->
                <td class="truncate" title="${row.observation || ''}">${row.observation || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updatePagination(data) {
        currentPage = data.page;
        totalPages = data.pages;
        document.getElementById('pageInfo').textContent = `Página ${data.page} de ${data.pages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            loadData();
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            loadData();
        }
    }

    async function triggerCMDBImport() {
        if (!confirm("Isso irá re-importar toda a base CMDB Full da planilha. Pode levar alguns segundos. Continuar?")) return;

        const btn = document.querySelector('button[onclick="triggerCMDBImport()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '⏳ Importando...';

        try {
            const res = await fetch('/api/import-cmdb-full', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'success') {
                alert('Importação concluída com sucesso!');
                loadFilters();
                loadStats();
                loadData();
            } else {
                alert('Erro: ' + data.message);
            }
        } catch (e) {
            alert('Erro na requisição: ' + e);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function animateValue(id, value) {
        const obj = document.getElementById(id);
        if (!obj) return;

        let start = parseInt(obj.innerText.replace(/\./g, '').replace(/,/g, '')) || 0;
        const end = parseInt(value) || 0;
        if (start === end) return;

        const duration = 1000;
        let startTime = null;

        function step(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('pt-BR');
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end.toLocaleString('pt-BR');
            }
        }
        window.requestAnimationFrame(step);
    }
</script>

{% endblock %}