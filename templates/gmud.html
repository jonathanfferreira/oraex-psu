{% extends "base.html" %}
{% block title_suffix %} â€” GMUDs{% endblock %}
{% block page_title %}GestÃ£o de GMUDs{% endblock %}
{% block page_subtitle %}Change Management â€” Changes request tracking{% endblock %}

{% block content %}

<div class="generator-card">
    <div class="generator-title">âš¡ Gerador de TÃ­tulo de GMUD</div>
    <div class="generator-form">
        <div class="form-group">
            <label class="form-label">Tipo</label>
            <select class="form-input" id="genType">
                <option value="Escopo Fechado">Escopo Fechado</option>
                <option value="Rotineira - Escopo Fechado">Rotineira - Escopo Fechado</option>
                <option value="Emergencial">Emergencial</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">VersÃ£o PSU</label>
            <select class="form-input" id="genPsu">
                <option value="19.30">19.30</option>
                <option value="19.29">19.29</option>
                <option value="19.28">19.28</option>
                <option value="19.27">19.27</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Prioridade (opcional)</label>
            <select class="form-input" id="genPriority">
                <option value="">Nenhuma</option>
                <option value="Prioridade PCI">Prioridade PCI</option>
                <option value="Prioridade Alta">Prioridade Alta</option>
            </select>
        </div>
        <div class="form-group full-width">
            <label class="form-label">Hostname(s)</label>
            <input type="text" class="form-input" id="genHostnames" placeholder="Ex: GNCASSPL05654 e GNCASNPL05655"
                oninput="generateTitle()">
        </div>
        <div class="form-group full-width">
            <label class="form-label">TÃ­tulo Gerado <small style="color: var(--text-dim)">(clique para
                    copiar)</small></label>
            <div class="generated-output" id="genOutput"
                onclick="copyToClipboard(this.textContent.replace('ðŸ“‹ Clique para copiar','').trim())">
                <span class="copy-hint">ðŸ“‹ Clique para copiar</span>
                Preencha os campos acima para gerar o tÃ­tulo...
            </div>
        </div>
    </div>
</div>

<div class="table-container" style="animation-delay: 0.2s">
    <div class="table-header">
        <div class="table-title">GMUDs (<span id="gmudCount">â€”</span>)</div>
        <div class="table-controls">
            <a href="/gmud/create" class="btn btn-primary"
                style="padding:0.4rem 0.8rem;display:flex;align-items:center;gap:0.4rem;text-decoration:none;font-size:0.78rem">
                <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                Nova GMUD
            </a>
            <button class="btn btn-secondary"
                style="padding:6px 12px;font-size:0.78rem;display:flex;align-items:center;gap:4px"
                onclick="exportCSV('/api/gmuds/export',{year:document.getElementById('gmudYearFilter').value,month:document.getElementById('gmudMonthFilter').value,status:document.getElementById('gmudStatusFilter').value,assigned_to:document.getElementById('gmudAssigneeFilter').value,search:document.getElementById('gmudSearch').value})">
                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" />
                </svg>CSV
            </button>
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="M21 21l-4.35-4.35" />
                </svg>
                <input type="text" class="search-input" id="gmudSearch" placeholder="Buscar CHG, tÃ­tulo..."
                    oninput="debouncedGmudSearch()">
            </div>
            <select class="filter-select" id="gmudYearFilter" onchange="loadGmuds()">
                <option value="">Ano</option>
            </select>
            <select class="filter-select" id="gmudMonthFilter" onchange="loadGmuds()">
                <option value="">MÃªs</option>
                <option value="1">Jan</option>
                <option value="2">Fev</option>
                <option value="3">Mar</option>
                <option value="4">Abr</option>
                <option value="5">Mai</option>
                <option value="6">Jun</option>
                <option value="7">Jul</option>
                <option value="8">Ago</option>
                <option value="9">Set</option>
                <option value="10">Out</option>
                <option value="11">Nov</option>
                <option value="12">Dez</option>
            </select>
            {% if not current_user.client_restriction or current_user.client_restriction == 'none' %}
            <select class="filter-select" id="gmudClientFilter" onchange="loadGmuds()">
                <option value="">Cliente (Todos)</option>
                <option value="GetNet">GetNet</option>
                <option value="PagoNxt">PagoNxt</option>
            </select>
            {% endif %}
            <select class="filter-select" id="gmudStatusFilter" onchange="loadGmuds()">
                <option value="">Status</option>
            </select>
            <select class="filter-select" id="gmudAssigneeFilter" onchange="loadGmuds()">
                <option value="">Recurso</option>
            </select>
        </div>
    </div>
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th>GMUD</th>
                    <th>TÃ­tulo</th>
                    <th>Cliente</th>
                    <th>Status</th>
                    <th>Entorno</th>
                    <th>Tipo BD</th>
                    <th>Data InÃ­cio</th>
                    <th>Data TÃ©rmino</th>
                    <th>Aberto Por</th>
                    <th>Designado a</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="gmudBody">
                <tr>
                    <td colspan="10" style="text-align:center;padding:40px">
                        <div class="spinner" style="margin:auto"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="gmudPagination"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentGmudPage = 1;
    const debouncedGmudSearch = debounce(() => { currentGmudPage = 1; loadGmuds(); });

    document.addEventListener('DOMContentLoaded', async () => {
        await loadGmudFilters();
        loadGmuds();
        ['genType', 'genPsu', 'genPriority'].forEach(id => {
            document.getElementById(id).addEventListener('change', generateTitle);
        });
    });

    async function loadGmudFilters() {
        try {
            const f = await API.filters();
            const yearSel = document.getElementById('gmudYearFilter');
            f.gmud_years.forEach(y => yearSel.innerHTML += `<option value="${y}">${y}</option>`);
            const statusSel = document.getElementById('gmudStatusFilter');
            f.gmud_statuses.forEach(s => statusSel.innerHTML += `<option value="${s}">${s}</option>`);
            const assigneeSel = document.getElementById('gmudAssigneeFilter');
            f.gmud_assignees.forEach(a => assigneeSel.innerHTML += `<option value="${a}">${a}</option>`);
        } catch (e) { showToast('Erro ao carregar filtros', 'error'); }
    }

    async function loadGmuds(page) {
        if (page) currentGmudPage = page;
        const body = document.getElementById('gmudBody');
        body.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px"><div class="spinner" style="margin:auto"></div></td></tr>';
        try {
            const data = await API.gmuds({
                year: document.getElementById('gmudYearFilter').value,
                month: document.getElementById('gmudMonthFilter').value,
                status: document.getElementById('gmudStatusFilter').value,
                assigned_to: document.getElementById('gmudAssigneeFilter').value,
                client: document.getElementById('gmudClientFilter') ? document.getElementById('gmudClientFilter').value : '',
                search: document.getElementById('gmudSearch').value,
                page: currentGmudPage, per_page: 50
            });
            document.getElementById('gmudCount').textContent = data.total.toLocaleString('pt-BR');
            if (!data.gmuds.length) { body.innerHTML = '<tr><td colspan="10"><div class="empty-state"><h3>Nenhuma GMUD encontrada</h3><p>Tente ajustar os filtros</p></div></td></tr>'; return; }
            body.innerHTML = data.gmuds.map(g => `
            <tr>
                <td style="font-family:monospace;font-weight:600;color:var(--accent-primary)">${g.change_number || 'â€”'}</td>
                <td style="max-width:320px;white-space:normal;line-height:1.4">${g.title || 'â€”'}</td>
                <td><span style="background:rgba(255,255,255,0.05);padding:2px 6px;border-radius:4px;font-size:0.8rem;border:1px solid rgba(255,255,255,0.1)">${g.client || 'â€”'}</span></td>
                <td>${getStatusBadge(g.status)}</td>
                <td>${getEnvBadge(g.environment)}</td>
                <td>${g.db_type || 'â€”'}</td>
                <td>${formatDateTime(g.start_date)}</td>
                <td>${formatDateTime(g.end_date)}</td>
                <td>
                    ${g.opened_by ? `<div style="display:flex;flex-direction:column;gap:2px"><span>${g.opened_by}</span><span style="font-size:0.65rem;color:var(--text-muted);opacity:0.7">${formatDateTime(g.created_at)}</span></div>` : 'â€”'}
                </td>
                <td>${g.assigned_to || 'â€”'}</td>
                <td>
                    <div style="display:flex;gap:3px">
                        <a href="/gmud/edit/${g.id}" class="btn-icon-sm" title="Editar"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></a>
                        <button class="btn-icon-sm danger" onclick="deleteGmud(${g.id},'${(g.change_number || '').replace(/'/g, "\\'")}')" title="Excluir"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></button>
                    </div>
                </td>
            </tr>`).join('');
            document.getElementById('gmudPagination').innerHTML = createPagination(data, 'loadGmuds');
        } catch (e) {
            body.innerHTML = '<tr><td colspan="10"><div class="empty-state"><h3>Erro ao carregar</h3></div></td></tr>';
            showToast('Erro: ' + e.message, 'error');
        }
    }

    async function deleteGmud(id, cn) {
        if (!confirm(`Excluir GMUD ${cn || id}? Esta aÃ§Ã£o nÃ£o pode ser desfeita.`)) return;
        try {
            const res = await fetch(`/api/gmud/${id}`, { method: 'DELETE' });
            const r = await res.json();
            if (res.ok) { showToast(r.message, 'success'); loadGmuds(); }
            else showToast('Erro: ' + r.message, 'error');
        } catch (e) { showToast('Erro: ' + e, 'error'); }
    }

    function generateTitle() {
        const type = document.getElementById('genType').value;
        const psu = document.getElementById('genPsu').value;
        const priority = document.getElementById('genPriority').value;
        const hosts = document.getElementById('genHostnames').value.trim();
        if (!hosts) { document.getElementById('genOutput').innerHTML = '<span class="copy-hint">ðŸ“‹ Clique para copiar</span>Preencha os campos acima para gerar o tÃ­tulo...'; return; }
        let prefix = `[${type} - BD`;
        if (priority) prefix += ` - ${priority}`;
        prefix += ']';
        const title = `${prefix} AtualizaÃ§Ã£o PSU ${psu} conforme orientaÃ§Ã£o Oracle | ${hosts}`;
        document.getElementById('genOutput').innerHTML = `<span class="copy-hint">ðŸ“‹ Clique para copiar</span>${title}`;
    }
</script>
{% endblock %}