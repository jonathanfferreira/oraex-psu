{% extends "base.html" %}

{% block content %}
<div class="content">
    <div class="header-container">
        <h1>Editar GMUD <span class="subtitle">Alterar dados da GMUD</span></h1>
    </div>

    <div class="gmud-form-container fade-in">
        <form id="gmudForm" onsubmit="event.preventDefault(); submitGmud();">

            <!-- Linha 1: Cliente e Tipo -->
            <div class="form-row">
                <div class="form-group">
                    <label for="client">Cliente</label>
                    <select id="client" name="client" required onchange="updatePreview()">
                        <option value="GetNet">GetNet</option>
                        <option value="PagoNxt">PagoNxt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="db_type">Tipo de Banco</label>
                    <select id="db_type" name="db_type" onchange="updatePreview()">
                        <option value="Oracle">Oracle</option>
                        <option value="SQL Server">SQL Server</option>
                        <option value="MySQL">MySQL</option>
                        <option value="PostgreSQL">PostgreSQL</option>
                        <option value="MongoDB">MongoDB</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="environment">Ambiente</label>
                    <select id="environment" name="environment" onchange="updatePreview()">
                        <option value="PROD">PROD</option>
                        <option value="PRE">PRE</option>
                        <option value="HML">HML</option>
                    </select>
                </div>
            </div>

            <!-- Linha 2: Hostnames e Busca -->
            <div class="form-group full-width">
                <label for="hostnames">Hostnames (Separe por vírgula ou busque)</label>
                <div class="search-wrapper">
                    <input type="text" id="hostnames" name="hostnames" placeholder="Ex: srv-db-01, srv-db-02"
                        oninput="handleHostInput()">
                    <div id="hostSuggestions" class="suggestions-box hidden"></div>
                </div>
            </div>

            <!-- Linha 3: Título -->
            <div class="form-group full-width">
                <label for="title">Título</label>
                <input type="text" id="title" name="title">
            </div>

            <!-- Linha 4: Datas -->
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">Data Início</label>
                    <input type="datetime-local" id="start_date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date">Data Fim</label>
                    <input type="datetime-local" id="end_date" name="end_date" required>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="Agendada">Agendada</option>
                        <option value="Planejada">Planejada</option>
                        <option value="Em Execução">Em Execução</option>
                        <option value="ENCERRADA">Encerrada</option>
                        <option value="CANCELADA">Cancelada</option>
                        <option value="REPLANEJAR">Replanejar</option>
                        <option value="PROGRAMADA">Programada</option>
                    </select>
                </div>
            </div>

            <!-- Linha 5: Detalhes -->
            <div class="form-row">
                <div class="form-group">
                    <label for="change_number">GMUD / Change Number</label>
                    <input type="text" id="change_number" name="change_number" placeholder="Ex: CHG000123">
                </div>
                <div class="form-group">
                    <label for="assigned_to">Responsável Técnico</label>
                    <input type="text" id="assigned_to" name="assigned_to" placeholder="Nome do DBA">
                </div>
                <div class="form-group">
                    <label for="opened_by">Aberto Por</label>
                    <input type="text" id="opened_by" name="opened_by" placeholder="Quem abriu o chamado">
                </div>
            </div>

            <!-- Linha 6: Observações -->
            <div class="form-group full-width">
                <label for="observation">Observações / Plano de Ação</label>
                <textarea id="observation" name="observation" rows="3"></textarea>
            </div>

            <!-- Linha 7: Vulnerabilidade -->
            <div class="form-group full-width">
                <label for="vulnerability">Vulnerabilidade (Opcional)</label>
                <input type="text" id="vulnerability" name="vulnerability">
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/gmud'">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Salvar Alterações
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const GMUD_ID = {{ gmud_id }};
    let searchTimeout;

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const res = await fetch(`/api/gmud/${GMUD_ID}`);
            if (!res.ok) {
                alert('GMUD não encontrada');
                window.location.href = '/gmud';
                return;
            }
            const gmud = await res.json();

            document.getElementById('client').value = gmud.client || 'GetNet';
            document.getElementById('db_type').value = gmud.db_type || 'Oracle';
            document.getElementById('environment').value = gmud.environment || 'PROD';
            document.getElementById('title').value = gmud.title || '';
            document.getElementById('change_number').value = gmud.change_number || '';
            document.getElementById('assigned_to').value = gmud.assigned_to || '';
            document.getElementById('opened_by').value = gmud.opened_by || '';
            document.getElementById('observation').value = gmud.observation || '';
            document.getElementById('vulnerability').value = gmud.vulnerability || '';

            // Set status
            const statusSel = document.getElementById('status');
            const statusVal = gmud.status || '';
            let matched = false;
            for (const opt of statusSel.options) {
                if (opt.value.toLowerCase() === statusVal.toLowerCase()) {
                    opt.selected = true;
                    matched = true;
                    break;
                }
            }
            if (!matched && statusVal) {
                const opt = document.createElement('option');
                opt.value = statusVal;
                opt.textContent = statusVal;
                opt.selected = true;
                statusSel.appendChild(opt);
            }

            // Parse dates
            if (gmud.start_date) {
                document.getElementById('start_date').value = gmud.start_date.replace(' ', 'T').slice(0, 16);
            }
            if (gmud.end_date) {
                document.getElementById('end_date').value = gmud.end_date.replace(' ', 'T').slice(0, 16);
            }

            // Extract hostnames from title
            if (gmud.title && gmud.title.includes('|')) {
                const parts = gmud.title.split('|');
                document.getElementById('hostnames').value = parts[parts.length - 1].trim();
            }
        } catch (e) {
            alert('Erro ao carregar GMUD: ' + e);
            window.location.href = '/gmud';
        }
    });

    function handleHostInput() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = document.getElementById('hostnames').value;
            if (query.length > 2) searchHosts(query);
        }, 500);
    }

    async function searchHosts(query) {
        const parts = query.split(',');
        const lastPart = parts[parts.length - 1].trim();

        if (lastPart.length < 2) {
            document.getElementById('hostSuggestions').classList.add('hidden');
            return;
        }

        try {
            const res = await fetch(`/api/hostnames?search=${encodeURIComponent(lastPart)}`);
            const results = await res.json();
            const box = document.getElementById('hostSuggestions');

            if (results.length === 0) {
                box.classList.add('hidden');
                return;
            }

            box.innerHTML = results.map(r =>
                `<div class="suggestion-item" onclick="selectHost('${r.hostname.replace(/'/g, "\\'")}')">
                    <span class="suggestion-hostname">${r.hostname}</span>
                    <span class="suggestion-source">${r.source}</span>
                </div>`
            ).join('');
            box.classList.remove('hidden');
        } catch (e) {
            console.error('Host search error:', e);
        }
    }

    function selectHost(hostname) {
        const input = document.getElementById('hostnames');
        const parts = input.value.split(',').map(p => p.trim()).filter(p => p);
        if (parts.length > 0) {
            parts[parts.length - 1] = hostname;
        } else {
            parts.push(hostname);
        }
        input.value = parts.join(', ') + ', ';
        document.getElementById('hostSuggestions').classList.add('hidden');
        input.focus();
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-wrapper')) {
            document.getElementById('hostSuggestions').classList.add('hidden');
        }
    });

    function updatePreview() {
        // Optional: auto-update title on edit page
    }

    async function submitGmud() {
        const btn = document.getElementById('submitBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '⏳ Salvando...';

        const formData = new FormData(document.getElementById('gmudForm'));
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch(`/api/gmud/${GMUD_ID}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (res.ok) {
                showToast(result.message, 'success');
                setTimeout(() => { window.location.href = '/gmud'; }, 1000);
            } else {
                showToast('Erro: ' + result.message, 'error');
            }
        } catch (e) {
            showToast('Erro de conexão: ' + e, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
</script>

{% endblock %}
