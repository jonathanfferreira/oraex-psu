{% extends "base.html" %}
{% block title_suffix %} — Gestão de Usuários{% endblock %}
{% block page_title %}Gestão de Usuários{% endblock %}
{% block page_subtitle %}Controle de acessos e restrições da plataforma{% endblock %}

{% block content %}

<div class="header-actions" style="margin-bottom: 2rem; display: flex; justify-content: flex-end;">
    <button onclick="openUserModal()" class="glass-panel"
        style="padding: 10px 20px; color: var(--brand-acid); border-color: rgba(0, 136, 238, 0.3); font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <path d="M12 5v14m-7-7h14" />
        </svg>
        Novo Usuário
    </button>
</div>

<!-- Tabela de Usuários -->
<div class="glass-panel" style="padding: 0; overflow: hidden;">
    <div class="table-responsive">
        <table class="table" id="usersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Usuário</th>
                    <th>Perfil (Role)</th>
                    <th>Cliente (Restrição)</th>
                    <th>Status</th>
                    <th style="text-align: right;">Ações</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <!-- Preenchido via JS -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Novo Usuário -->
<div id="userModal" class="modal-backdrop"
    style="display: none; position: fixed; top: 0; left: 0; wioh: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-panel" style="width: 100%; max-width: 500px; padding: 2rem;">
        <h2 style="color: var(--text-primary); margin-bottom: 1.5rem; font-family: 'Space Mono', monospace;">>_ Novo
            Usuário</h2>
        <form id="userForm" onsubmit="createUser(event)">
            <div style="margin-bottom: 1rem;">
                <label
                    style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Nome
                    de Exibição</label>
                <input type="text" id="uName" required
                    style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label
                    style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Username</label>
                <input type="text" id="uLogin" required
                    style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label
                    style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Senha</label>
                <input type="password" id="uPass" required minlength="6"
                    style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="flex: 1;">
                    <label
                        style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Perfil
                        (Role)</label>
                    <select id="uRole"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                        <option value="viewer" style="background:#05050A">Viewer (Apenas Leitura)</option>
                        <option value="dba" style="background:#05050A">DBA (Leitura + Lançamentos)</option>
                        <option value="admin" style="background:#05050A">Admin (Acesso Total)</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label
                        style="color: var(--text-secondary); font-size: 0.875rem; display: block; margin-bottom: 0.5rem;">Visão
                        Cliente</label>
                    <select id="uClient"
                        style="width: 100%; padding: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 4px;">
                        <option value="none" style="background:#05050A">Global (Todos)</option>
                        <option value="GetNet" style="background:#05050A">Somente GetNet</option>
                        <option value="PagoNxt" style="background:#05050A">Somente PagoNxt</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeUserModal()"
                    style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px; cursor: pointer;">Cancelar</button>
                <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--brand-acid); border: none; color: black; font-weight: bold; border-radius: 4px; cursor: pointer;">Salvar
                    Usuário</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", loadUsers);

    async function loadUsers() {
        try {
            const res = await fetch("/api/users");
            const data = await res.json();
            const tbody = document.getElementById("usersTableBody");
            tbody.innerHTML = "";

            data.forEach(u => {
                const tr = document.createElement("tr");
                const roleBadge = u.role === 'admin' ? '<span style="color:var(--brand-acid)">Admin</span>' : u.role;
                const clientBadge = u.client_restriction === 'none' ? 'Global' : u.client_restriction;
                const statusBadge = u.is_active
                    ? '<span style="color:var(--success)">Ativo</span>'
                    : '<span style="color:var(--danger)">Inativo</span>';

                const toggleTxt = u.is_active ? 'Desativar' : 'Ativar';

                tr.innerHTML = `
                    <td>#${u.id}</td>
                    <td style="font-weight:bold; color:white;">${u.display_name}</td>
                    <td style="color:var(--text-secondary)">${u.username}</td>
                    <td style="text-transform: capitalize;">${roleBadge}</td>
                    <td>${clientBadge}</td>
                    <td>${statusBadge}</td>
                    <td style="text-align: right; font-size: 0.8rem;">
                        <button onclick="toggleStatus(${u.id}, ${!u.is_active})" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:4px 8px; border-radius:4px; margin-right:5px; cursor:pointer">${toggleTxt}</button>
                        <button onclick="resetPassword(${u.id}, '${u.username}')" style="background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:4px 8px; border-radius:4px; cursor:pointer">Resetar Senha</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error("Erro ao carregar usuários", e);
        }
    }

    function openUserModal() {
        document.getElementById("userForm").reset();
        document.getElementById("userModal").style.display = "flex";
    }

    function closeUserModal() {
        document.getElementById("userModal").style.display = "none";
    }

    async function createUser(e) {
        e.preventDefault();
        const payload = {
            display_name: document.getElementById('uName').value,
            username: document.getElementById('uLogin').value,
            password: document.getElementById('uPass').value,
            role: document.getElementById('uRole').value,
            client_restriction: document.getElementById('uClient').value
        };

        try {
            const res = await fetch("/api/users", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === "success") {
                closeUserModal();
                loadUsers();
            } else {
                alert("Erro: " + data.message);
            }
        } catch (e) {
            alert("Erro inesperado ao criar usuário.");
        }
    }

    async function toggleStatus(id, activate) {
        if (!confirm(`Deseja realmente ${activate ? 'ativar' : 'desativar'} este usuário?`)) return;
        try {
            await fetch(`/api/users/${id}/status`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ is_active: activate })
            });
            loadUsers();
        } catch (e) {
            alert("Erro ao alterar status");
        }
    }

    async function resetPassword(id, username) {
        const newPass = prompt(`Digite a nova senha para ${username} (min. 6 caracteres):`);
        if (!newPass) return;
        if (newPass.length < 6) return alert("Senha muito curta.");

        try {
            await fetch(`/api/users/${id}/reset-password`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ new_password: newPass })
            });
            alert("Senha alterada com sucesso!");
        } catch (e) {
            alert("Erro ao alterar senha");
        }
    }
</script>
{% endblock %}